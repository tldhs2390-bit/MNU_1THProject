<!DOCTYPE html>
<html lang="ja"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç®¡ç†è€…ãƒ¡ã‚¤ãƒ³ | Izakaya SION</title>

  <link rel="stylesheet" href="/css/index.css" />
  <link rel="stylesheet" href="/css/admin/admin.css" />

  <style>
    /* â— ê¸ˆì§€ ì»¤ì„œë§Œ í‘œì‹œ (ìƒ‰ìƒ/íˆ¬ëª…ë„ ì ˆëŒ€ ë³€ê²½ ì—†ìŒ) */
    .admin-menu-card.cursor-blocked {
      cursor: not-allowed;
    }

    /* =========================
       âœ… ìš”ì²­ ë°˜ì˜: ë¡œê·¸ì¸/ì ‘ì†ì¤‘/ë¡œê·¸ì•„ì›ƒ ì „ë¶€ "ì§ê°"
       âœ… ë¡œê·¸ì¸(ë²„íŠ¼/ì¸í’‹)ì€ "ì•¡ì ì œê±°"
       - ê¸°ëŠ¥/JS/êµ¬ì¡°ëŠ” ê·¸ëŒ€ë¡œ
    ========================= */

    /* ë¡œê·¸ì¸ ë°°ë„ˆ(ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ / æ¥ç¶šä¸­) ì§ê° */
    .admin-login-title{
      border-radius: 0 !important;
    }

    /* ë¡œê·¸ì¸ input ì§ê° */
    .admin-login input{
      border-radius: 0 !important;
    }

    /* ë¡œê·¸ì¸ ë²„íŠ¼: ì§ê° + ì•¡ì ì œê±°(í”„ë ˆì„ í…Œë‘ë¦¬ ì œê±°) */
    .admin-login button{
      border-radius: 0 !important;
      border: none !important;     /* âœ… ì•¡ì ì œê±° */
      box-shadow: none !important; /* âœ… ì•¡ì ëŠë‚Œ ì œê±° */
      background: #111 !important; /* ê¸°ì¡´ ìœ ì§€ */
      color: #fff !important;
    }
    .admin-login button:hover{
      opacity: 0.92;
      transform: none !important;
      box-shadow: none !important;
    }

    /* ì ‘ì†ì¤‘ ë°•ìŠ¤(ì„¸ì…˜ ì˜ì—­) ì§ê° */
    .admin-session-box{
      border-radius: 0 !important;
    }

    /* âœ…âœ…âœ… íƒ€ì´ë¨¸ UI ìˆ¨ê¹€ (ê¸°ëŠ¥ì€ JSë¡œ ìœ ì§€) */
    .admin-session-timer{
      display:none !important;
    }

    /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼: ì§ê° + ì•¡ì ì œê±° */
    .admin-session-box form button {
      width: 100%;
      padding: 10px;
      background: #111 !important;
      color: #fff !important;
      border: none !important;      /* âœ… ì•¡ì ì œê±° */
      border-radius: 0 !important;  /* âœ… ì§ê° */
      box-shadow: none !important;  /* âœ… ì•¡ì ëŠë‚Œ ì œê±° */
      cursor: pointer;
      transform: none !important;
    }
    .admin-session-box form button:hover {
      opacity: 0.92;
      transform: none !important;
      box-shadow: none !important;
    }
  </style>
</head>

<body class="admin">

<header class="admin-topbar">
  <div class="admin-topbar__inner admin-topbar__inner--center">
    <a href="/admin/main" class="admin-topbar__brand">
      å±…é…’å±‹ã‚·ã‚ªãƒ³(ç®¡ç†è€…)
    </a>
  </div>
</header>

<main class="admin-dashboard">

  <!-- SIDEBAR -->
  <aside class="admin-sidebar">

    <div class="admin-sidebar__logo">
      <a href="/" aria-label="ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸">
        <img src="/images/logo-brand.png" alt="SION" class="admin-logo">
      </a>
    </div>

    <!-- ğŸ” ë¡œê·¸ì¸ ì „ -->
    <form class="admin-login"
          sec:authorize="!isAuthenticated()"
          method="post"
          action="/admin/login">

      <div class="admin-login-title">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</div>

      <input type="text" name="username" placeholder="ç®¡ç†è€…ID" required />
      <input type="password" name="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required />
      <button type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </form>

    <!-- ğŸ” ë¡œê·¸ì¸ í›„ -->
    <div class="admin-login admin-session-box"
         sec:authorize="isAuthenticated()">

      <div class="admin-login-title">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ã§æ¥ç¶šä¸­</div>

      <!-- âœ… íƒ€ì´ë¨¸ UIëŠ” ìˆ¨ê¹€ ì²˜ë¦¬ë¨(.admin-session-timer display:none) -->
      <div class="admin-session-timer" aria-hidden="true">
        æ®‹ã‚Šæ™‚é–“
        <strong>
          <span id="timerMin">10</span>åˆ†
          <span id="timerSec">00</span>ç§’
        </strong>
      </div>

      <form method="post" action="/admin/logout">
        <button type="submit">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </form>
    </div>

  </aside>

  <!-- MAIN -->
  <section class="admin-main">

    <div class="admin-card-grid">

      <a href="/admin/menu/list" class="admin-menu-card admin-only">
        <h3>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†</h3>
        <p>æ–™ç†ãƒ»ä¾¡æ ¼ãƒ»ç”»åƒç®¡ç†</p>
      </a>

      <a href="/admin/store" class="admin-menu-card admin-only">
        <h3>åº—èˆ—ç™»éŒ²</h3>
        <p>åº—èˆ—æƒ…å ±ãƒ»URLç®¡ç†</p>
      </a>

      <a href="/admin/campaign" class="admin-menu-card admin-only">
        <h3>ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç™»éŒ²</h3>
        <p>ã‚¤ãƒ™ãƒ³ãƒˆãƒ»å‘ŠçŸ¥ç®¡ç†</p>
      </a>

      <a href="/admin/dashboard" class="admin-menu-card admin-only">
        <h3>åº—èˆ—çŠ¶æ³</h3>
        <p>äºˆç´„ãƒ»ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆé›†è¨ˆ</p>
      </a>

      <a href="/admin/sales" class="admin-menu-card admin-only">
        <h3>å£²ä¸Šçµ±è¨ˆ</h3>
        <p>æœŸé–“åˆ¥ãƒ»åº—èˆ—åˆ¥ã®å£²ä¸Šåˆ†æ</p>
      </a>

      <a href="https://www.instagram.com/izakaya_sion/"
         class="admin-menu-card admin-only"
         data-instagram>
        <h3>å…¬å¼Instagramç®¡ç†</h3>
        <p>æŠ•ç¨¿ãƒ»é€£æºè¨­å®š</p>
      </a>

    </div>

  </section>

</main>

<footer class="admin-footer">
  <small>Â© å±…é…’å±‹ã‚·ã‚ªãƒ³ Admin</small>
</footer>

<!-- ğŸ”‘ ì¸ì¦ ìƒíƒœ -->
<script th:inline="javascript">
  const IS_AUTHENTICATED =
    /*[[${#authentication != null and #authentication.authenticated}]]*/ false;
</script>

<!-- ğŸ”’ ë©”ë‰´ ì¹´ë“œ ì œì–´ (ìƒ‰ìƒ ìœ ì§€ + ê¸ˆì§€ ì»¤ì„œë§Œ) -->
<script>
document.addEventListener('DOMContentLoaded', () => {

  document.querySelectorAll('.admin-only').forEach(card => {

    if (!IS_AUTHENTICATED) {
      // âœ… ì»¤ì„œë§Œ ê¸ˆì§€
      card.classList.add('cursor-blocked');
    }

    card.addEventListener('click', e => {
      if (!IS_AUTHENTICATED) {
        e.preventDefault();
        alert('ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«åˆ©ç”¨ã§ãã¾ã™ã€‚');
      }
    });

  });

});
</script>

<!-- ğŸ“¸ Instagram popup (ë¡œê·¸ì¸ ì‹œë§Œ) -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const insta = document.querySelector('[data-instagram]');
  if (!insta) return;

  insta.addEventListener('click', e => {
    if (!IS_AUTHENTICATED) {
      e.preventDefault();
      return;
    }

    e.preventDefault();
    window.open(
      insta.href,
      "instagramPopup",
      "width=1200,height=700,resizable=yes,scrollbars=yes"
    );
  });
});
</script>

<!-- â± ë¡œê·¸ì¸ í›„: 10ë¶„ ì§€ë‚˜ë©´ ìë™ ë¡œê·¸ì•„ì›ƒ (UI ì—†ì´ ê¸°ëŠ¥ë§Œ) -->
<script sec:authorize="isAuthenticated()">
document.addEventListener('DOMContentLoaded', () => {

  const AUTO_LOGOUT_MS = 10 * 60 * 1000; // 10ë¶„

  const doLogout = async () => {
    try {
      await fetch('/admin/logout', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      });
    } catch (e) {
      // ë¬´ì‹œ
    } finally {
      location.href = '/admin/main?logout';
    }
  };

  // âœ… 10ë¶„ í›„ ìë™ ë¡œê·¸ì•„ì›ƒ
  setTimeout(doLogout, AUTO_LOGOUT_MS);

  // ğŸ”„ ì„œë²„ ì„¸ì…˜ ì²´í¬ (5ì´ˆë§ˆë‹¤) - ê¸°ì¡´ ìœ ì§€
  setInterval(async () => {
    try {
      const res = await fetch('/admin/session-check', { cache: 'no-store' });
      const alive = await res.json();

      if (!alive) {
        location.reload(); // âœ… ì„¸ì…˜ ë§Œë£Œ â†’ ìƒˆë¡œê³ ì¹¨
      }
    } catch (e) {
      location.reload();
    }
  }, 5000);

});
</script>

<!-- keepalive (ê¸°ì¡´ ìœ ì§€) -->
<script>
(() => {
  let lastPing = 0;
  const INTERVAL = 60 * 1000; // 1ë¶„ì— 1ë²ˆë§Œ ì„œë²„ í˜¸ì¶œ

  const pingServer = () => {
    const now = Date.now();
    if (now - lastPing < INTERVAL) return;

    lastPing = now;

    fetch('/admin/session-keepalive', {
      method: 'GET',
      credentials: 'same-origin'
    }).catch(() => {
      // ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ
    });
  };

  // ì‚¬ìš©ì í™œë™ ê°ì§€ â†’ ì„¸ì…˜ ì—°ì¥
  ['mousemove', 'click', 'keydown', 'scroll'].forEach(event => {
    document.addEventListener(event, pingServer, { passive: true });
  });
})();
</script>

<!-- ì•Œë¦¼ -->
<script th:if="${param.error}">
  alert("IDåŠã³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚");
</script>
<script th:if="${param.logout}">
  alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚");
</script>

</body>
</html>