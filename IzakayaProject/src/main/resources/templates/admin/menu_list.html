<!DOCTYPE html>
<html lang="ja"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8" />
  <title>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ | Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="/css/index.css" />
  <link rel="stylesheet" href="/css/admin/admin.css" />
  <link rel="stylesheet" href="/css/admin/menu.css" />

  <style>
    .admin-menu-card.cursor-blocked { cursor: not-allowed; }

    /* âœ… íƒ€ì´ë¨¸ UI ìˆ¨ê¹€(ê¸°ëŠ¥ì€ JSë¡œ ìœ ì§€) */
    .admin-session-timer{ display:none !important; }

    /* âœ… ì‚¬ì´ë“œë°” ì „ì²´ ê°€ìš´ë° */
    .admin-sidebar{ text-align:center; }

    /* âœ… íƒ€ì´í‹€ ì§ê° + ê°€ìš´ë° */
    .admin-login-title{
      border-radius:0 !important;
      text-align:center !important;
    }

    /* âœ… ì‚¬ì´ë“œë°” ë§í¬ ì§ê° + ê°€ìš´ë° */
    .admin-side-links{ text-align:center; }
    .admin-side-link{
      border-radius:0 !important;
      text-align:center !important;
      justify-content:center;
    }

    /* âœ… ë¡œê·¸ì¸ í¼ ì§ê°/ê°€ìš´ë° */
    .admin-login input{
      border-radius:0 !important;
      text-align:center;
    }

    /* =========================
       ğŸ”¥ íˆ¬ëª…/í•©ì„± ë¬¸ì œ ì°¨ë‹¨ (menu_list ì „ìš©)
       - ì ‘ì†ì¤‘ë§Œ íˆ¬ëª…í•´ì§€ëŠ” ì¼€ì´ìŠ¤ ë°©ì§€
    ========================= */
    body.admin.admin-menu-list .admin-login,
    body.admin.admin-menu-list .admin-session-box{
      opacity: 1 !important;
      filter: none !important;
      mix-blend-mode: normal !important;
      isolation: isolate;
    }

    /* =========================
       âœ… ë²„íŠ¼ ìŠ¤íƒ€ì¼ = "ê´€ë¦¬ì ë©”ì¸"ê³¼ ë™ì¼í•˜ê²Œ
       - ì§ê° + ì•¡ì ì œê±° + background #111
       - hover: opacity 0.92
    ========================= */

    /* ë¡œê·¸ì¸ ë²„íŠ¼(ë¡œê·¸ì¸ ì „) */
    body.admin.admin-menu-list .admin-login button{
      border-radius: 0 !important;
      border: none !important;
      box-shadow: none !important;

      background: #111 !important;
      background-image: none !important;
      color: #fff !important;

      opacity: 1 !important;
      filter: none !important;
      mix-blend-mode: normal !important;

      transform: none !important;
      text-align: center !important;
      cursor: pointer;
    }
    body.admin.admin-menu-list .admin-login button:hover{
      opacity: 0.92 !important;
      transform: none !important;
      box-shadow: none !important;
    }

    /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼(ì ‘ì†ì¤‘) - ê´€ë¦¬ì ë©”ì¸ê³¼ ë™ì¼ */
    body.admin.admin-menu-list .admin-session-box form button{
      width: 100%;
      padding: 10px;

      background: #111 !important;
      background-image: none !important;
      color: #fff !important;

      border: none !important;
      border-radius: 0 !important;
      box-shadow: none !important;

      opacity: 1 !important;
      filter: none !important;
      mix-blend-mode: normal !important;

      cursor: pointer;
      transform: none !important;
      text-align: center !important;
    }
    body.admin.admin-menu-list .admin-session-box form button:hover{
      opacity: 0.92 !important;
      transform: none !important;
      box-shadow: none !important;
    }
    /* =========================
   ì¹´í…Œê³ ë¦¬ ì ‘ê¸°/í¼ì¹˜ê¸°
========================= */

/* ê¸°ë³¸ì€ í¼ì³ì§„ ìƒíƒœ */
.admin-category-body {
  overflow: hidden;
  transition: max-height 0.25s ease, opacity 0.2s ease;
}

/* ì ‘íŒ ìƒíƒœ */
.admin-category-body.is-collapsed {
  max-height: 0 !important;
  opacity: 0;
  pointer-events: none;
}

/* í—¤ë” í™”ì‚´í‘œ */
.admin-category-head::after {
  content: "â–²";
  margin-left: auto;
  font-size: 12px;
  opacity: 0.6;
  transition: transform 0.2s ease;
}

/* ì ‘í˜”ì„ ë•Œ í™”ì‚´í‘œ */
.admin-category-head.is-collapsed::after {
  transform: rotate(180deg);
}
/* =========================
   ì¹´í…Œê³ ë¦¬ í—¤ë” ë°°ì§€ë§Œ í¬ê¸° ì—…
   (ë¦¬ìŠ¤íŠ¸ ì•ˆì€ ê·¸ëŒ€ë¡œ ìœ ì§€)
========================= */
.admin-category-head .admin-badge{
  padding: 10px 18px;   /* ë°•ìŠ¤ë§Œ í‚¤ì›€ */
  font-size: 17px;     /* ê¸€ì”¨ë§Œ í‚¤ì›€ */
  font-weight: 900;
  border-radius: 0;
}
.admin-table th,
.admin-table td {
  text-align: center;
  vertical-align: middle;
}

/* ì´ë¦„ ì»¬ëŸ¼ë§Œ ì™¼ìª½ ì •ë ¬í•˜ê³  ì‹¶ìœ¼ë©´ ì´ê±´ ìœ ì§€ */
.admin-table .admin-td-title {
  text-align: center;
}
/* ì¹´í…Œê³ ë¦¬(2ì—´) â†’ ì˜¤ë¥¸ìª½ ì—¬ë°± ì¤„ì´ê¸° */
.admin-table th:nth-child(2),
.admin-table td:nth-child(2) {
  padding-right: 6px;
}

/* í‘œì‹œìˆœì„œ(3ì—´) â†’ ì™¼ìª½ ì—¬ë°± ì¤„ì´ê¸° */
.admin-table th:nth-child(3),
.admin-table td:nth-child(3) {
  padding-left: 6px;
}
  </style>
</head>

<body class="admin admin-menu-list">

<header class="admin-topbar">
  <div class="admin-topbar__inner admin-topbar__inner--center">
    <a href="/admin/main" class="admin-topbar__brand">
      å±…é…’å±‹ã‚·ã‚ªãƒ³(ç®¡ç†è€…)
    </a>
  </div>
</header>

<main class="admin-dashboard">

  <aside class="admin-sidebar">

    <div class="admin-sidebar__logo">
      <a href="/" aria-label="ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸">
        <img src="/images/logo-brand.png" alt="SION" class="admin-logo">
      </a>
    </div>

    <div class="admin-login-title">ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>

    <div class="admin-side-links">
      <a href="/admin/main" class="admin-side-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
      <a href="/admin/menu/list" class="admin-side-link active">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†</a>
      <a href="/admin/store/list" class="admin-side-link">åº—èˆ—ç®¡ç†</a>
    </div>

    <!-- ğŸ” ë¡œê·¸ì¸ ì „ -->
    <form class="admin-login"
          sec:authorize="!isAuthenticated()"
          method="post"
          action="/admin/login">

      <div class="admin-login-title">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</div>

      <input type="text" name="username" placeholder="ç®¡ç†è€…ID" required />
      <input type="password" name="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required />
      <button type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </form>

    <!-- ğŸ” ë¡œê·¸ì¸ í›„ -->
    <div class="admin-login admin-session-box"
         sec:authorize="isAuthenticated()">
      <div class="admin-login-title">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ã§æ¥ç¶šä¸­</div>

     

      <form method="post" action="/admin/logout">
        <button type="submit">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </form>
    </div>

  </aside>

  <section class="admin-main">
    <div class="admin-page">

      <div class="admin-page-head">
        <h2 class="admin-page-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>

        <a href="/admin/menu/insert" class="admin-primary-btn">
          æ–°è¦ç™»éŒ²
        </a>
      </div>

      <th:block th:if="${groupedItems == null || #maps.isEmpty(groupedItems)}">
        <div class="admin-empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      </th:block>

      <th:block th:if="${groupedItems != null && !#maps.isEmpty(groupedItems)}">
        <th:block th:each="entry : ${groupedItems}">
          <div class="admin-category-head js-category-toggle"
     style="margin:18px 0 10px; display:flex; align-items:center; gap:10px; cursor:pointer;">
            <span class="admin-badge"
                  th:text="${
                    entry.key != null && entry.key.name() == 'SINGLE'    ? 'å˜å“ãƒ¡ãƒ‹ãƒ¥ãƒ¼' :
                    entry.key != null && entry.key.name() == 'MAIN'      ? 'éººãƒ»ã”é£¯é¡' :
                    entry.key != null && entry.key.name() == 'FRIED_PAN' ? 'æšã’ç‰©ãƒ»ãƒãƒ‚ãƒŸ' :
                    entry.key != null && entry.key.name() == 'SNACK'     ? 'ç°¡å˜ãŠã¤ã¾ã¿' :
                    (entry.key != null ? entry.key.name() : '')
                  }">ã‚«ãƒ†ã‚´ãƒª</span>

            <span style="font-weight:900; color:#2b1f14;"
                  th:text="${#lists.size(entry.value)} + 'å€‹'">0å€‹</span>
          </div>

<div class="admin-table-wrap admin-category-body">            
<table class="admin-table">
             
  <thead>
    <tr>
      <th>ID</th>
      <th style="width:200px;" class="admin-td-center">ã‚«ãƒ†ã‚´ãƒª</th>
      <th style="width:180px;" class="admin-td-center">è¡¨ç¤ºé †</th>
      <th style="width:160px;" class="admin-td-center">åå‰</th>
      <th style="width:160px;" class="admin-td-center">ä¾¡æ ¼</th>
      <th style="width:110px;" class="admin-td-center">å…¬é–‹</th>
      <th style="width:140px;" class="admin-td-center">æ“ä½œ</th>
    </tr>
  </thead>

              <tbody>
              <tr th:each="m : ${entry.value}">
                <td th:text="${m.id}">1</td>

                <td>
                  <span class="admin-badge"
                        th:text="${
                          m.category != null && m.category.name() == 'SINGLE'    ? 'å˜å“ãƒ¡ãƒ‹ãƒ¥ãƒ¼' :
                          m.category != null && m.category.name() == 'MAIN'      ? 'éººãƒ»ã”é£¯é¡' :
                          m.category != null && m.category.name() == 'FRIED_PAN' ? 'æšã’ç‰©ãƒ»ãƒãƒ‚ãƒŸ' :
                          m.category != null && m.category.name() == 'SNACK'     ? 'ç°¡å˜ãŠã¤ã¾ã¿' :
                          (m.category != null ? m.category.name() : '')
                        }">SINGLE</span>
                </td>

                <td th:text="${m.sortOrder}">1</td>

                <td class="admin-td-title">
                  <div class="admin-title" th:text="${m.name}">æµ·é®®ãƒãƒ‚ãƒŸ</div>
                  <div class="admin-sub"
                       th:if="${m.tagText != null && m.tagText != ''}"
                       th:text="${m.tagText}">äººæ°—</div>
                </td>

                <td th:text="${m.priceText}" class="admin-td-center">Â¥980ï¼ˆç¨è¾¼ï¼‰</td>

                <td class="admin-td-center">
                  <span class="admin-pill"
                        th:classappend="${m.visible} ? ' is-on' : ' is-off'"
                        th:text="${m.visible} ? 'å…¬é–‹' : 'éå…¬é–‹'">å…¬é–‹</span>
                </td>

                <td class="admin-td-center">
                  <div class="admin-actions admin-actions--center">
                    <a th:href="@{/admin/menu/edit(id=${m.id})}" class="admin-action-btn">ç·¨é›†</a>

                    <form th:action="@{/admin/menu/delete}" method="post" class="admin-action-form">
                      <input type="hidden" name="id" th:value="${m.id}">
                      <button type="submit" class="admin-action-btn danger"
                              onclick="return confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                        å‰Šé™¤
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>

        </th:block>
      </th:block>

    </div>
  </section>

</main>

<footer class="admin-footer">
  <small>Â© å±…é…’å±‹ã‚·ã‚ªãƒ³ Admin</small>
</footer>

<script th:inline="javascript">
  const IS_AUTHENTICATED = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
</script>

<!-- âœ… ê¸°ëŠ¥ ìœ ì§€: 10ë¶„ ìë™ ë¡œê·¸ì•„ì›ƒ + ì„¸ì…˜ ì²´í¬ -->
<script sec:authorize="isAuthenticated()">
document.addEventListener('DOMContentLoaded', () => {

  const AUTO_LOGOUT_MS = 10 * 60 * 1000;

  const doLogout = async () => {
    try {
      await fetch('/admin/logout', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      });
    } catch (e) {
    } finally {
      location.href = '/admin/main?logout';
    }
  };

  setTimeout(doLogout, AUTO_LOGOUT_MS);

  setInterval(async () => {
    try {
      const res = await fetch('/admin/session-check', { cache: 'no-store' });
      const alive = await res.json();
      if (!alive) location.reload();
    } catch (e) {
      location.reload();
    }
  }, 5000);

});
</script>

<!-- âœ… keepalive ìœ ì§€ -->
<script>
(() => {
  let lastPing = 0;
  const INTERVAL = 60 * 1000;

  const pingServer = () => {
    const now = Date.now();
    if (now - lastPing < INTERVAL) return;
    lastPing = now;

    fetch('/admin/session-keepalive', {
      method: 'GET',
      credentials: 'same-origin'
    }).catch(() => {});
  };

  ['mousemove', 'click', 'keydown', 'scroll'].forEach(event => {
    document.addEventListener(event, pingServer, { passive: true });
  });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {

  document.querySelectorAll('.js-category-toggle').forEach(head => {
    const body = head.nextElementSibling;
    if (!body || !body.classList.contains('admin-category-body')) return;

    // ì²˜ìŒ ë¡œë“œ ì‹œ: í¼ì¹œ ìƒíƒœ
    body.style.maxHeight = body.scrollHeight + 'px';

    head.addEventListener('click', () => {
      const collapsed = body.classList.toggle('is-collapsed');
      head.classList.toggle('is-collapsed', collapsed);

      if (collapsed) {
        body.style.maxHeight = '0px';
      } else {
        body.style.maxHeight = body.scrollHeight + 'px';
      }
    });
  });

});
</script>
</body>
</html>