<!DOCTYPE html>
<html lang="ja"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8" />
  <title>メニュー | Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="/css/index.css" />
  <link rel="stylesheet" href="/css/admin/admin.css" />
  <link rel="stylesheet" href="/css/admin/menu.css" />

  <style>
    .admin-menu-card.cursor-blocked { cursor: not-allowed; }

    /* ✅ 사이드바 전체 가운데 */
    .admin-sidebar{ text-align:center; }

    /* ✅ 타이틀 직각 + 가운데 */
    .admin-login-title{
      border-radius:0 !important;
      text-align:center !important;
    }

    /* ✅ 사이드바 링크 직각 + 가운데 */
    .admin-side-links{ text-align:center; }
    .admin-side-link{
      border-radius:0 !important;
      text-align:center !important;
      justify-content:center;
    }

    /* ✅ 로그인 폼 직각/가운데 */
    .admin-login input{
      border-radius:0 !important;
      text-align:center;
    }

    /* =========================================================
       ✅✅✅ [핵심] 접속중 "회색 카드(바깥 프레임)"만 제거
       - 배너(.admin-login-title)는 그대로 살아있음 → 2번 이미지처럼 됨
       - 구조/배치/기능 그대로
    ========================================================= */
    body.admin.admin-menu-list .admin-login.admin-session-box{
      background: transparent !important;
      border: none !important;
      outline: none !important;
      box-shadow: none !important;

      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;

      /* admin.css의 .admin-login 여백감 유지 */
      padding-top: 14px !important;
      padding-bottom: 50px !important;

      opacity: 1 !important;
      filter: none !important;
      mix-blend-mode: normal !important;
      isolation: isolate;
    }

    /* ✅ 로그아웃 버튼(접속중) - 관리자 메인과 동일 */
    body.admin.admin-menu-list .admin-session-box form button{
      width: 100%;
      padding: 10px;

      background: #111 !important;
      background-image: none !important;
      color: #fff !important;

      border: none !important;
      border-radius: 0 !important;
      box-shadow: none !important;

      opacity: 1 !important;
      filter: none !important;
      mix-blend-mode: normal !important;

      cursor: pointer;
      transform: none !important;
      text-align: center !important;
    }
    body.admin.admin-menu-list .admin-session-box form button:hover{
      opacity: 0.92 !important;
      transform: none !important;
      box-shadow: none !important;
    }

    /* 로그인 버튼(로그인 전) */
    body.admin.admin-menu-list .admin-login button{
      border-radius: 0 !important;
      border: none !important;
      box-shadow: none !important;

      background: #111 !important;
      background-image: none !important;
      color: #fff !important;

      opacity: 1 !important;
      filter: none !important;
      mix-blend-mode: normal !important;

      transform: none !important;
      text-align: center !important;
      cursor: pointer;
    }
    body.admin.admin-menu-list .admin-login button:hover{
      opacity: 0.92 !important;
      transform: none !important;
      box-shadow: none !important;
    }

    /* =========================
       카테고리 접기/펼치기
    ========================= */
    .admin-category-body {
      overflow: hidden;
      transition: max-height 0.25s ease, opacity 0.2s ease;
    }
    .admin-category-body.is-collapsed {
      max-height: 0 !important;
      opacity: 0;
      pointer-events: none;
    }
    .admin-category-head::after {
      content: "▲";
      margin-left: auto;
      font-size: 12px;
      opacity: 0.6;
      transition: transform 0.2s ease;
    }
    .admin-category-head.is-collapsed::after {
      transform: rotate(180deg);
    }

    /* 헤더 배지 크게 */
    .admin-category-head .admin-badge{
      padding: 10px 18px;
      font-size: 17px;
      font-weight: 900;
      border-radius: 0;
    }

    .admin-table th,
    .admin-table td {
      text-align: center;
      vertical-align: middle;
    }
    .admin-table .admin-td-title {
      text-align: center;
    }
    .admin-table th:nth-child(2),
    .admin-table td:nth-child(2) {
      padding-right: 6px;
    }
    .admin-table th:nth-child(3),
    .admin-table td:nth-child(3) {
      padding-left: 6px;
    }
    
  </style>
</head>

<body class="admin admin-menu-list">

<header class="admin-topbar">
  <div class="admin-topbar__inner admin-topbar__inner--center">
    <a href="/admin/main" class="admin-topbar__brand">
      居酒屋シオン(管理者)
    </a>
  </div>
</header>

<main class="admin-dashboard">

  <aside class="admin-sidebar">

    <div class="admin-sidebar__logo">
      <a href="/" aria-label="トップページへ">
        <img src="/images/logo-brand.png" alt="SION" class="admin-logo">
      </a>
    </div>

    <div class="admin-login-title">管理メニュー</div>

    <div class="admin-side-links">
      <a href="/admin/main" class="admin-side-link">ダッシュボード</a>
      <a href="/admin/menu/list" class="admin-side-link active">メニュー管理</a>
      <a href="/admin/store/list" class="admin-side-link">店舗管理</a>
    </div>

    <form class="admin-login"
          sec:authorize="!isAuthenticated()"
          method="post"
          action="/admin/login">
      <div class="admin-login-title">管理者ログイン</div>
      <input type="text" name="username" placeholder="管理者ID" required />
      <input type="password" name="password" placeholder="パスワード" required />
      <button type="submit">ログイン</button>
    </form>

    <div class="admin-login admin-session-box"
         sec:authorize="isAuthenticated()">
      <div class="admin-login-title">管理者ログインで接続中</div>

     

      <form method="post" action="/admin/logout">
        <button type="submit">ログアウト</button>
      </form>
    </div>
  </aside>

  <section class="admin-main">
    <div class="admin-page">

      <div class="admin-page-head">
        <h2 class="admin-page-title">メニュー</h2>

        <a href="/admin/menu/insert" class="admin-primary-btn">
          新規登録
        </a>
      </div>

      <th:block th:if="${groupedItems == null || #maps.isEmpty(groupedItems)}">
        <div class="admin-empty">データがありません。</div>
      </th:block>

      <th:block th:if="${groupedItems != null && !#maps.isEmpty(groupedItems)}">
        <th:block th:each="entry : ${groupedItems}">
          <div class="admin-category-head js-category-toggle"
     th:attr="data-key=${entry.key != null ? entry.key.name() : 'UNKNOWN'}"
     style="margin:18px 0 10px; display:flex; align-items:center; gap:10px; cursor:pointer;">
            <span class="admin-badge"
                  th:text="${
                    entry.key != null && entry.key.name() == 'SINGLE'    ? '単品メニュー' :
                    entry.key != null && entry.key.name() == 'MAIN'      ? '麺・ご飯類' :
                    entry.key != null && entry.key.name() == 'FRIED_PAN' ? '揚げ物・チヂミ' :
                    entry.key != null && entry.key.name() == 'SNACK'     ? '簡単おつまみ' :
                    (entry.key != null ? entry.key.name() : '')
                  }">カテゴリ</span>

            <span style="font-weight:900; color:#2b1f14;"
                  th:text="${#lists.size(entry.value)} + '個'">0個</span>
          </div>

          <div class="admin-table-wrap admin-category-body">
            <table class="admin-table">
              <thead>
              <tr>
				<th>No</th>                
				<th style="width:200px;" class="admin-td-center">カテゴリ</th>
                <th style="width:180px;" class="admin-td-center">表示順</th>
                <th style="width:160px;" class="admin-td-center">名前</th>
                <th style="width:160px;" class="admin-td-center">価格</th>
                <th style="width:110px;" class="admin-td-center">公開</th>
                <th style="width:140px;" class="admin-td-center">操作</th>
              </tr>
              </thead>

              <tbody>
				<tr th:each="m, st : ${entry.value}">
				<td th:text="${st.count}">1</td>
                <td>
                  <span class="admin-badge"
                        th:text="${
                          m.category != null && m.category.name() == 'SINGLE'    ? '単品メニュー' :
                          m.category != null && m.category.name() == 'MAIN'      ? '麺・ご飯類' :
                          m.category != null && m.category.name() == 'FRIED_PAN' ? '揚げ物・チヂミ' :
                          m.category != null && m.category.name() == 'SNACK'     ? '簡単おつまみ' :
                          (m.category != null ? m.category.name() : '')
                        }">SINGLE</span>
                </td>

                <td th:text="${m.sortOrder}">1</td>

                <td class="admin-td-title">
                  <div class="admin-title" th:text="${m.name}">海鮮チヂミ</div>
                  <div class="admin-sub"
                       th:if="${m.tagText != null && m.tagText != ''}"
                       th:text="${m.tagText}">人気</div>
                </td>

                <td th:text="${m.priceText}" class="admin-td-center">¥980（税込）</td>

                <td class="admin-td-center">
                  <span class="admin-pill"
                        th:classappend="${m.visible} ? ' is-on' : ' is-off'"
                        th:text="${m.visible} ? '公開' : '非公開'">公開</span>
                </td>

                <td class="admin-td-center">
                  <div class="admin-actions admin-actions--center">
                    <a th:href="@{/admin/menu/edit(id=${m.id})}" class="admin-action-btn">編集</a>

                    <form th:action="@{/admin/menu/delete}" method="post" class="admin-action-form">
                      <input type="hidden" name="id" th:value="${m.id}">
                      <button type="submit" class="admin-action-btn danger"
                              onclick="return confirm('削除しますか？');">
                        削除
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>

        </th:block>
      </th:block>

    </div>
  </section>

</main>

<footer class="admin-footer">
  <small>© 居酒屋シオン Admin</small>
</footer>

<script th:inline="javascript">
  const IS_AUTHENTICATED = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
</script>

<!-- ✅ 기능 유지: 10분 자동 로그아웃 + 세션 체크 -->
<script sec:authorize="isAuthenticated()">
document.addEventListener('DOMContentLoaded', () => {

  const AUTO_LOGOUT_MS = 10 * 60 * 1000;

  const doLogout = async () => {
    try {
      await fetch('/admin/logout', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      });
    } catch (e) {
    } finally {
      location.href = '/admin/main?logout';
    }
  };

  setTimeout(doLogout, AUTO_LOGOUT_MS);

  setInterval(async () => {
    try {
      const res = await fetch('/admin/session-check', { cache: 'no-store' });
      const alive = await res.json();
      if (!alive) location.reload();
    } catch (e) {
      location.reload();
    }
  }, 5000);

});
</script>

<!-- ✅ keepalive 유지 -->
<script>
(() => {
  let lastPing = 0;
  const INTERVAL = 60 * 1000;

  const pingServer = () => {
    const now = Date.now();
    if (now - lastPing < INTERVAL) return;
    lastPing = now;

    fetch('/admin/session-keepalive', {
      method: 'GET',
      credentials: 'same-origin'
    }).catch(() => {});
  };

  ['mousemove', 'click', 'keydown', 'scroll'].forEach(event => {
    document.addEventListener(event, pingServer, { passive: true });
  });
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const STORAGE_KEY = 'admin_menu_list_category_collapsed_v1';

  const loadState = () => {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}') || {};
    } catch (e) {
      return {};
    }
  };

  const saveState = (state) => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state || {}));
    } catch (e) {}
  };

  const state = loadState();

  document.querySelectorAll('.js-category-toggle').forEach(head => {
    const body = head.nextElementSibling;
    if (!body || !body.classList.contains('admin-category-body')) return;

    const key = head.getAttribute('data-key') || head.textContent.trim() || 'UNKNOWN';

    // ✅ 저장된 상태 반영 (true면 접힘)
    const shouldCollapse = state[key] === true;

    if (shouldCollapse) {
      body.classList.add('is-collapsed');
      head.classList.add('is-collapsed');
      body.style.maxHeight = '0px';
    } else {
      body.classList.remove('is-collapsed');
      head.classList.remove('is-collapsed');
      body.style.maxHeight = body.scrollHeight + 'px';
    }

    head.addEventListener('click', () => {
      const collapsed = body.classList.toggle('is-collapsed');
      head.classList.toggle('is-collapsed', collapsed);

      if (collapsed) {
        body.style.maxHeight = '0px';
      } else {
        body.style.maxHeight = body.scrollHeight + 'px';
      }

      // ✅ 상태 저장
      state[key] = collapsed;
      saveState(state);
    });
  });

});
</script>
</body>
</html>